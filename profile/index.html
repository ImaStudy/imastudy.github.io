<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî ImaStudy</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <style>
       * {
  box-sizing: border-box;
}

     body {
    font-family: 'Noto Sans', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f4;
  }

    nav {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
  padding: 0 20px;
}

nav button {
  background-color: #ddd;
  border: none;
  padding: 10px 20px;   
  font-size: 14px;       
  font-weight: 600;   
  cursor: pointer;
  color: #3498db;   
  border-radius: 5px;
  transition: color 0.3s, background-color 0.3s;
}

nav button:hover,
nav button.active {
  background-color: transparent;;
  color: #2980b9;
}

    main {
      flex-grow: 1;
    }
    h1 {
  margin-top: 0;
}

    button {
    background-color: #3498db;
    color: white;
    cursor: pointer;
  }

  button:hover {
    background-color: #2980b9;
  }

.profile-info {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 20px;
  background: white;
  margin: 20px auto;
  max-width: 600px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.profile-info img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
}

.stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 20px auto;
  max-width: 600px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 45%;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.stat-card h3 {
  margin: 0;
  font-size: 28px;
  color: #3498db;
}

.actions {
  text-align: center;
  margin-top: 20px;
}
    
.actions button {
  width: auto;
  padding: 10px 20px;
  margin: 5px;
  border-radius: 5px;
  font-size: 14px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  text-align: center;
}

.modal-content input {
  width: 100%;
  padding: 10px;
  margin: 15px 0;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

.modal-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
}

.toast {
  min-width: 250px;
  margin-left: -125px;
  background-color: #2ecc71;
  color: white;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  z-index: 1000;
  left: 50%;
  bottom: 30px;
  font-size: 16px;
  opacity: 0;
  pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
  transition: opacity 0.5s ease, bottom 0.5s ease;
}

.toast.show {
  opacity: 1;
  bottom: 50px;
  pointer-events: auto;
}

.input-error {
  border: 2px solid #e74c3c !important;
}

.error-message {
  color: #e74c3c;
  font-size: 13px;
  margin-top: -10px;
  margin-bottom: 10px;
  display: none;
}
    
    footer {
    text-align: center;
    font-size: 14px;
    color: #666;
    margin-top: 40px;
  }
  </style>
</head>
<body>
  
 <header>
  <div class="header-left">
    <h1>ImaStudy</h1>
    <p>–†–∞–∑–º–µ—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏–µ ‚Äî –ø–æ–ª—É—á–∏ –ø–æ–º–æ—â—å</p>
  </div>
 <nav class="desktop-nav">
  <button class="tab-button" id="homeTab" onclick="window.location.href='/'">–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="tab-button" id="tasksTab" onclick="viewTasksWithoutLogin()">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</button>
</nav>
   <nav class="mobile-nav">
  <button class="tab-button" id="homeTabMobile" onclick="window.location.href='/'">–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="tab-button" id="tasksTabMobile" onclick="viewTasksWithoutLogin()">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</button>
</nav>
</header>
<hr />

  <main>
  <section class="profile-info">
    <div style="position: relative;">
  <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User" alt="Avatar" />
  <label for="avatar-upload" style="position: absolute; bottom: 0; right: 0; background: #3498db; color: white; border-radius: 50%; padding: 6px; cursor: pointer;">
    üì∑
  </label>
  <input type="file" id="avatar-upload" accept="image/*" style="display: none;" />
</div>
    <div>
      <h2 id="user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
      <p id="user-email">email@example.com</p>
      <button class="edit-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </section>

  <section class="stats">
    <div class="stat-card">
      <h3 id="tasks-created">0</h3>
      <p>–†–∞–∑–º–µ—â–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π</p>
    </div>
    <div class="stat-card">
      <h3 id="tasks-done">0</h3>
      <p>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π</p>
    </div>
  </section>

  <section class="actions">
    <button id="home-btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    <button id="logout-btn">–í—ã–π—Ç–∏</button>
  </section>
</main>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</h3>
    <input type="text" id="newNameInput" placeholder="–ù–æ–≤–æ–µ –∏–º—è" />
    <div id="nameError" class="error-message">–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã 2 –±—É–∫–≤—ã</div>
    <div class="modal-actions">
      <button id="saveNameBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="cancelEditBtn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
<div id="toast" class="toast">–ò–º—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!</div>

  <div id="cropModal" class="modal">
  <div class="modal-content">
    <h3>–û–±—Ä–µ–∑–∞—Ç—å —Ñ–æ—Ç–æ</h3>
    <div><img id="crop-image" style="max-width: 100%; max-height: 300px;" /></div>
    <div class="modal-actions">
      <button id="cropConfirmBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="cropModal.style.display = 'none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

  
  <footer>
    &copy; 2025 ImaStudy. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
  </footer>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_ahS1_vqjYA6fpzM0tTBZx-oBkL3X2Jo",
      authDomain: "imastudy-631ec.firebaseapp.com",
      projectId: "imastudy-631ec",
      storageBucket: "imastudy-631ec.appspot.com",
      messagingSenderId: "301505972939",
      appId: "1:301505972939:web:061de2a898044090dae94e",
      measurementId: "G-305V13PQ4Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const welcomeMessage = document.getElementById("welcome-message");
    const logoutBtn = document.getElementById("logout-btn");
    const homeBtn = document.getElementById("home-btn");
    const userNameEl = document.getElementById("user-name");
    const userEmailEl = document.getElementById("user-email");
    const avatarEl = document.getElementById("profile-avatar");

import { updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const editBtn = document.querySelector(".edit-btn");
const editModal = document.getElementById("editModal");
const newNameInput = document.getElementById("newNameInput");
const saveNameBtn = document.getElementById("saveNameBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");

let currentUser = null;

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

    
editBtn.addEventListener("click", () => {
  if (currentUser) {
    newNameInput.value = currentUser.displayName || "";
    editModal.style.display = "flex";
  }
});

cancelEditBtn.addEventListener("click", () => {
  editModal.style.display = "none";
});

saveNameBtn.addEventListener("click", async () => {
  const newName = newNameInput.value.trim();
  const nameError = document.getElementById("nameError");

  if (newName.length < 2) {
    newNameInput.classList.add("input-error");
    nameError.style.display = "block";
    return;
  }

  try {
    await updateProfile(currentUser, { displayName: newName });
    userNameEl.textContent = newName;

    const currentPhoto = currentUser.photoURL || "";
    const isDefaultAvatar =
      !currentPhoto ||
      currentPhoto.includes("ui-avatars.com") ||
      currentPhoto.includes("googleusercontent.com");

    if (isDefaultAvatar) {
      const newAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=random`;
      avatarEl.src = newAvatar;
      await updateProfile(currentUser, { photoURL: newAvatar });
    }

    editModal.style.display = "none";
    showToast("–ò–º—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
  } catch (error) {
    console.error(error);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏.");
  }
});

 newNameInput.addEventListener("input", () => {
  const nameError = document.getElementById("nameError");
  const value = newNameInput.value.trim();

  if (value.length >= 2) {
    newNameInput.classList.remove("input-error");
    nameError.style.display = "none";
  } else {
    newNameInput.classList.add("input-error");
    nameError.style.display = "block";
  }
});


    

    onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    const name = user.displayName || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    const email = user.email;
    userNameEl.textContent = name;
    userEmailEl.textContent = email;
    avatarEl.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
  } else {
    setTimeout(() => window.location.href = "/login/", 1500);
  }
});

const avatarInput = document.getElementById("avatar-upload");

    let cropper;
const cropModal = document.getElementById("cropModal");
const cropImage = document.getElementById("crop-image");
const cropConfirmBtn = document.getElementById("cropConfirmBtn");

avatarInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (!file || !currentUser) return;

  const reader = new FileReader();
  reader.onload = () => {
    cropImage.src = reader.result;
    cropModal.style.display = "flex";
    
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1,
      dragMode: 'move',
      background: false
    });
  };
  reader.readAsDataURL(file);
});

cropConfirmBtn.addEventListener("click", async () => {
  if (!cropper || !currentUser) return;

  cropper.getCroppedCanvas({
    width: 300,
    height: 300,
    imageSmoothingQuality: "high"
  }).toBlob(async (blob) => {
    if (!blob) {
      console.log("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
      return;
    }

    const formData = new FormData();
    formData.append("file", blob);
    formData.append("upload_preset", "unsigned_avatar"); // üëà –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π preset, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
    formData.append("folder", "avatars");

    try {
      const response = await fetch("https://api.cloudinary.com/v1_1/difr4y6th/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      const photoURL = data.secure_url;
      console.log("Cloudinary photoURL:", photoURL);

      await updateProfile(currentUser, { photoURL });
      avatarEl.src = photoURL;
      showToast("–ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞:", error);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä: " + error.message);
    } finally {
      cropModal.style.display = "none";
      cropper.destroy();
    }
  }, "image/jpeg", 0.95);
});



    
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "/";
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: " + error.message);
      }
    });

    homeBtn.addEventListener("click", () => {
      window.location.href = "/";
    });
  </script>
</body>
  
</html>
