<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî ImaStudy</title>
 <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet" />
 <link rel="stylesheet" href="/style.css" />
 <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
 <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
 <style>
      * {
 box-sizing: border-box;
}

    body {
   font-family: 'Noto Sans', sans-serif;
   margin: 0;
   padding: 0;
   background-color: #f4f4f4;
 }

   nav {
 display: flex;
 justify-content: center;
 gap: 10px;
 margin-top: 20px;
 max-width: 800px;
 margin-left: auto;
 margin-right: auto;
 padding: 0 20px;
}

nav button {
 background-color: #ddd;
 border: none;
 padding: 10px 20px;   
 font-size: 14px;       
 font-weight: 600;   
 cursor: pointer;
 color: #3498db;   
 border-radius: 5px;
 transition: color 0.3s, background-color 0.3s;
}

nav button:hover,
nav button.active {
 background-color: transparent;;
 color: #2980b9;
}

   main {
     flex-grow: 1;
   }
   h1 {
 margin-top: 0;
}

   button {
   background-color: #3498db;
   color: white;
   cursor: pointer;
 }

 button:hover {
   background-color: #2980b9;
 }

.profile-card {
  background: white;
  margin: 20px auto;
  padding: 30px;
  max-width: 1000px; /* —Å—Ç–∞–ª–æ —à–∏—Ä–µ */
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 25px;
  margin-bottom: 30px;
}
  
.profile-header img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
}

#user-name {
  margin-bottom: 2px;
}

#user-email {
  margin-top: 0;
}
  
.avatar-edit {
  position: absolute;
  bottom: 0;
  right: 0;
  background: #3498db;
  color: white;
  border-radius: 50%;
  padding: 6px;
  cursor: pointer;
}
  
.profile-bio h3 {
  margin-bottom: 10px;
  font-size: 18px;
}

.profile-bio p {
  color: #555;
  margin-bottom: 10px;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.stats {
 display: flex;
 justify-content: center;
 gap: 30px;
 margin: 20px auto;
 max-width: 600px;
}

.stat-card {
 background: white;
 padding: 20px;
 border-radius: 10px;
 width: 45%;
 text-align: center;
 box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.stat-card h3 {
 margin: 0;
 font-size: 28px;
 color: #3498db;
}

.actions {
 text-align: center;
 margin-top: 20px;
}
   
.actions button {
 width: auto;
 padding: 10px 20px;
 margin: 5px;
 border-radius: 5px;
 font-size: 14px;
}

.modal {
 display: none;
 position: fixed;
 z-index: 1000;
 left: 0; top: 0;
 width: 100%; height: 100%;
 background-color: rgba(0,0,0,0.4);
 justify-content: center;
 align-items: center;
}

.modal-content {
 background: white;
 padding: 20px;
 border-radius: 10px;
 width: 90%;
 max-width: 400px;
 box-shadow: 0 2px 10px rgba(0,0,0,0.2);
 text-align: center;
}

.modal-content input {
 width: 100%;
 padding: 10px;
 margin: 15px 0;
 font-size: 16px;
 border: 1px solid #ccc;
 border-radius: 5px;
}

.modal-actions {
 display: flex;
 justify-content: center;
 gap: 10px;
}

.toast {
 min-width: 250px;
 margin-left: -125px;
 background-color: #2ecc71;
 color: white;
 text-align: center;
 border-radius: 8px;
 padding: 12px;
 position: fixed;
 z-index: 1000;
 left: 50%;
 bottom: 30px;
 font-size: 16px;
 opacity: 0;
 pointer-events: none;
 transition: opacity 0.5s ease, bottom 0.5s ease;
}

.toast.show {
 opacity: 1;
 bottom: 50px;
 pointer-events: auto;
}

  .toast.success {
  background-color: #2ecc71;
}

.input-error {
  border: 2px solid #e74c3c;
}

.error-message {
  color: #e74c3c;
  font-size: 13px;
  font-weight: 600;
  margin-top: 5px;
  opacity: 0;
  height: 0;
  transition: opacity 0.3s ease, height 0.3s ease;
  overflow: hidden;
}

.error-message.show {
  opacity: 1;
  height: auto;
}

.inline-input.input-error,
.inline-textarea.input-error {
  border-color: #e74c3c;
}

#user-bio {
  word-wrap: break-word;
  white-space: pre-wrap;
}

  .profile-bio {
  margin-top: 30px;
}

.inline-input, .inline-textarea {
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  color: inherit;
  width: 100%;
  max-width: 520px;
  padding: 2px 0;
  border: none;
  border-bottom: 2px solid #ccc;
  background: transparent;
  outline: none;
  transition: border-color 0.3s;
}

.inline-input:focus, .inline-textarea:focus {
  border-color: #3498db;
}

.inline-textarea {
  resize: none;
  overflow: hidden;
}

 .inline-input.input-error {
  border-color: #e74c3c;
}

.inline-input.input-error:focus,
.inline-textarea.input-error:focus {
  border-color: #e74c3c; 
}

#name-error {
  color: #e74c3c;
  font-size: 13px;
  margin-top: 5px;
  opacity: 0;
  height: 0;
  transition: opacity 0.3s ease, height 0.3s ease;
  overflow: hidden;
}

#name-error.show {
  opacity: 1;
  height: auto;
}
 
#bio-error {
  color: #e74c3c;
}
  
#editProfileBtn, #cancelEditBtn {
  display: inline-block;
  padding: 10px 22px;
  font-size: 15px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background-color: #3498db;
  color: white;
  margin-left: 6px;
  width: auto;
  white-space: nowrap;
  transition: background 0.3s;
}

#editProfileBtn:hover,
#cancelEditBtn:hover {
  background-color: #2980b9;
}
  .hidden {
  display: none;
}
  #cancelEditBtn {
  display: none;
}

.profile-bio h3 {
  margin-bottom: 10px;
  font-size: 18px;
}

.profile-bio p {
  margin: 0 0 15px 0;
  padding: 0;
  background: none;
}

   footer {
   text-align: center;
   font-size: 14px;
   color: #666;
   margin-top: 40px;
 }
 </style>
</head>
<body> 
<header>
 <div class="header-left">
   <h1>ImaStudy</h1>
   <p>–†–∞–∑–º–µ—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏–µ ‚Äî –ø–æ–ª—É—á–∏ –ø–æ–º–æ—â—å</p>
 </div>
<nav class="desktop-nav">
 <button class="tab-button" id="homeTab" onclick="window.location.href='/'">–ì–ª–∞–≤–Ω–∞—è</button>
 <button class="tab-button" id="tasksTab" onclick="viewTasksWithoutLogin()">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</button>
</nav>
  <nav class="mobile-nav">
 <button class="tab-button" id="homeTabMobile" onclick="window.location.href='/'">–ì–ª–∞–≤–Ω–∞—è</button>
 <button class="tab-button" id="tasksTabMobile" onclick="viewTasksWithoutLogin()">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</button>
</nav>
</header>
<hr />

 <main>
 <section class="profile-card">
   <div class="profile-header">
     <div style="position: relative;">
       <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User" alt="Avatar" />
       <label for="avatar-upload" class="avatar-edit">üì∑</label>
       <input type="file" id="avatar-upload" accept="image/*" style="display: none;" />
     </div>
     <div>
       <h2 id="user-name"></h2>
       <p id="name-error" class="error-message">–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 2 —Å–∏–º–≤–æ–ª–æ–≤</p>
       <p id="user-email"></p>
     </div>
   </div>
  
  <div class="profile-bio">
  <h3>–û —Å–µ–±–µ</h3>
  <p id="user-bio">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ...</p>
<p id="bio-error" class="error-message">
  –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤
</p>

  <button id="editProfileBtn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  <button id="cancelEditBtn" class="hidden">–û—Ç–º–µ–Ω–∞</button>
</div>
 </section>
</main>

 <div id="cropModal" class="modal">
 <div class="modal-content">
   <h3>–û–±—Ä–µ–∑–∞—Ç—å —Ñ–æ—Ç–æ</h3>
   <div><img id="crop-image" style="max-width: 100%; max-height: 300px;" /></div>
   <div class="modal-actions">
     <button id="cropConfirmBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
     <button onclick="cropModal.style.display = 'none'">–û—Ç–º–µ–Ω–∞</button>
   </div>
 </div>
</div>


 <footer>
   ¬© 2025 ImaStudy. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
 </footer>

 <div id="toast" class="toast"></div>

 <script>
const userNameEl = document.getElementById("user-name");
const userEmailEl = document.getElementById("user-email");
const avatarEl = document.getElementById("profile-avatar");
const userBioEl = document.getElementById("user-bio");

const cachedName = localStorage.getItem("cachedName");
const cachedEmail = localStorage.getItem("cachedEmail");
const cachedPhotoURL = localStorage.getItem("cachedPhotoURL");
const cachedBio = localStorage.getItem("cachedBio");

if (cachedName) userNameEl.textContent = cachedName;
if (cachedEmail) userEmailEl.textContent = cachedEmail;
if (cachedPhotoURL) avatarEl.src = cachedPhotoURL;
userBioEl.textContent = cachedBio || "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ...";
  
</script>
 
 <script type="module">
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_ahS1_vqjYA6fpzM0tTBZx-oBkL3X2Jo",
  authDomain: "imastudy-631ec.firebaseapp.com",
  projectId: "imastudy-631ec",
  storageBucket: "imastudy-631ec.appspot.com",
  messagingSenderId: "301505972939",
  appId: "1:301505972939:web:061de2a898044090dae94e",
  measurementId: "G-305V13PQ4Q"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);
const db = getFirestore(app);

const editProfileBtn = document.getElementById("editProfileBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const userNameEl = document.getElementById("user-name");
const userEmailEl = document.getElementById("user-email");
const userBioEl = document.getElementById("user-bio");
const avatarEl = document.getElementById("profile-avatar");

cancelEditBtn.style.display = "none";

let currentUser = null;
let oldName = "";
let oldBio = "";
let justUpdatedProfile = false;

const nameInput = document.createElement("input");
nameInput.type = "text";
nameInput.className = "inline-input";
nameInput.placeholder = "–ù–∏–∫–Ω–µ–π–º";

const nameErrorEl = document.getElementById("name-error");

const bioInput = document.createElement("textarea");
bioInput.rows = 4;
bioInput.className = "inline-textarea";
bioInput.placeholder = "–û —Å–µ–±–µ";

bioInput.addEventListener("input", () => {
  autoResizeTextarea(bioInput);

  bioInput.classList.remove("input-error");
  bioErrorEl.classList.remove("show");
});  
  
function showToast(message, type = "success") {
  const toast = document.getElementById("toast");
  toast.textContent = message;

  toast.className = "toast";
  toast.classList.add("show", type);

  setTimeout(() => toast.classList.remove("show"), 3000);
}


function autoResizeTextarea(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

function enterEditMode() {
  oldName = userNameEl.textContent.trim();
  oldBio = userBioEl.textContent.trim();

  nameInput.value = oldName;
  bioInput.value = oldBio === "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ..." ? "" : oldBio;

  userNameEl.innerHTML = "";
  userNameEl.appendChild(nameInput);

  userBioEl.innerHTML = "";
  userBioEl.appendChild(bioInput);

  editProfileBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å";
  editProfileBtn.dataset.mode = "edit";
  cancelEditBtn.style.display = "inline-block";
}

function exitEditMode() {
  editProfileBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å";
  editProfileBtn.dataset.mode = "view";

  userNameEl.textContent = oldName;
  userBioEl.textContent = oldBio || "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ...";

  cancelEditBtn.style.display = "none";
}

const bioErrorEl = document.getElementById("bio-error");

editProfileBtn.addEventListener("click", async () => {
  if (editProfileBtn.dataset.mode !== "edit") {
    enterEditMode();
    return;
  }

  const newName = nameInput.value.trim();
  const newBio = bioInput.value.trim();

  if (newName.length < 2) {
    nameInput.classList.add("input-error");
    nameErrorEl.classList.add("show");
    return;
  } else {
    nameInput.classList.remove("input-error");
    nameErrorEl.classList.remove("show");
  }

  if (newBio !== "" && newBio.length < 10) {
    bioInput.classList.add("input-error");
    bioErrorEl.classList.add("show");
    return;
  } else {
    bioInput.classList.remove("input-error");
    bioErrorEl.classList.remove("show");
  }

  userNameEl.textContent = newName;
  userBioEl.textContent = newBio === "" ? "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ..." : newBio;

  exitEditMode();
  showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!", "success");

 if (currentUser) {
    try {
      await updateProfile(currentUser, { displayName: newName, photoURL: avatarEl.src });
      await setDoc(doc(db, "users", currentUser.uid), { bio: newBio }, { merge: true });
      showToast("–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±–∞–∑–µ!");
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ Firebase:", err);
      showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ", "error");
    }
  }
});

cancelEditBtn.addEventListener("click", () => exitEditMode());
  
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    setTimeout(() => window.location.href = "/login/", 1500);
    return;
  }

  currentUser = user;

  const name  = user.displayName || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
  const email = user.email;
  const photo = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;

  avatarEl.src = photo;
  userEmailEl.textContent = email;
  userNameEl.textContent = name;

  localStorage.setItem("cachedName", name);
  localStorage.setItem("cachedEmail", email);
  localStorage.setItem("cachedPhotoURL", photo);

  const cachedBio = localStorage.getItem("cachedBio") || "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ...";
  userBioEl.textContent = cachedBio;
});

const avatarInput = document.getElementById("avatar-upload");

   let cropper;
const cropModal = document.getElementById("cropModal");
const cropImage = document.getElementById("crop-image");
const cropConfirmBtn = document.getElementById("cropConfirmBtn");

avatarInput.addEventListener("change", (event) => {
 const file = event.target.files[0];
 if (!file || !currentUser) return;

 const reader = new FileReader();
 reader.onload = () => {
   cropImage.src = reader.result;
   cropModal.style.display = "flex";
   
   if (cropper) cropper.destroy();
   cropper = new Cropper(cropImage, {
     aspectRatio: 1,
     viewMode: 1,
     dragMode: 'move',
     background: false
   });
 };
 reader.readAsDataURL(file);
});

cropConfirmBtn.addEventListener("click", async () => {
 if (!cropper || !currentUser) return;

 cropper.getCroppedCanvas({
   width: 300,
   height: 300,
   imageSmoothingQuality: "high"
 }).toBlob(async (blob) => {
   if (!blob) {
     console.log("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
     return;
   }

   const formData = new FormData();
   formData.append("file", blob);
   formData.append("upload_preset", "unsigned_avatar");
   formData.append("folder", "avatars");

   try {
     const response = await fetch("https://api.cloudinary.com/v1_1/difr4y6th/image/upload", {
       method: "POST",
       body: formData
     });

     const data = await response.json();
     const photoURL = data.secure_url;
     console.log("Cloudinary photoURL:", photoURL);

     await updateProfile(currentUser, { photoURL });
     avatarEl.src = photoURL;
     showToast("–ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!");
   } catch (error) {
     console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞:", error);
     alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä: " + error.message);
   } finally {
     cropModal.style.display = "none";
     cropper.destroy();
   }
 }, "image/jpeg", 0.95);
});

  
window.viewTasksWithoutLogin = function() {
window.location.href = "/tasks/";
};
 </script>
</body>
 
</html>
